<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Global Success 7 â€” Unit 7: TRAFFIC (Offline Game)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2e; --text:#eaf0ff; --muted:#a9b6d6;
      --line:#233656; --accent:#4dd6ff; --accent2:#79ffb0; --warn:#ffcc66; --bad:#ff5c7a; --good:#4cff9a;
      --shadow:0 10px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(77,214,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(121,255,176,.14), transparent 55%),
                  linear-gradient(180deg, #060b16, #0b1220 45%, #070c17);
    }
    .app{max-width:1180px;margin:0 auto;padding:16px 12px 40px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow); position:sticky; top:10px; z-index:50; backdrop-filter:blur(10px);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:14px;display:grid;place-items:center;font-weight:900;color:#06101f;
      background:linear-gradient(135deg, rgba(77,214,255,.9), rgba(121,255,176,.9));}
    .t1{font-weight:900;font-size:14px}
    .t2{font-size:12px;color:var(--muted);margin-top:2px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03)}
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;user-select:none;font-weight:800;
      transition:.15s transform,.15s background;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.07)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(77,214,255,.45);background:rgba(77,214,255,.12)}
    .btn.good{border-color:rgba(121,255,176,.45);background:rgba(121,255,176,.10)}
    .btn.warn{border-color:rgba(255,204,102,.55);background:rgba(255,204,102,.10)}
    .btn.bad{border-color:rgba(255,92,122,.55);background:rgba(255,92,122,.10)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .range{appearance:none;height:6px;width:140px;background:rgba(255,255,255,.12);border-radius:999px;outline:none}
    .range::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;
      background:linear-gradient(135deg, rgba(77,214,255,.95), rgba(121,255,176,.95));border:2px solid rgba(0,0,0,.25);cursor:pointer}
    .main{margin-top:14px;display:grid;grid-template-columns:320px 1fr;gap:14px}
    @media (max-width:980px){.main{grid-template-columns:1fr}}
    .sidebar,.contentçŸ¥é“{
      border:1px solid var(--line);border-radius:var(--r);background:rgba(255,255,255,.03);
      box-shadow:var(--shadow);padding:14px;
    }
    .sidebar,.content{
      border:1px solid var(--line);border-radius:var(--r);background:rgba(255,255,255,.03);
      box-shadow:var(--shadow);padding:14px;
    }
    .sidebar{height:fit-content;position:sticky;top:92px}
    @media (max-width:980px){.sidebar{position:relative;top:auto}}
    .card{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(255,255,255,.02)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted)}
    .nav{display:flex;flex-direction:column;gap:8px}
    .navItem{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;
      border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.02);cursor:pointer}
    .navItem.active{border-color:rgba(77,214,255,.45);background:rgba(77,214,255,.10)}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .progressBar{height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;margin-top:10px}
    .progressBar>div{height:100%;width:0;background:linear-gradient(90deg, rgba(77,214,255,.95), rgba(121,255,176,.95));transition:width .25s}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    @media (max-width:760px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;background:rgba(255,255,255,.02)}
    .kpi .n{font-weight:900;font-size:18px}
    .kpi .l{color:var(--muted);font-size:12px;margin-top:4px}
    .sectionHeader{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:12px;margin-bottom:12px}
    .sectionHeader h2{margin:0;font-size:18px}
    .sectionHeader .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .q{border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;background:rgba(8,14,28,.35);margin-bottom:10px}
    .qTitle{margin:0 0 6px 0;font-weight:900;font-size:14px}
    .opts{display:grid;gap:8px;margin-top:10px}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 10px;border:1px solid rgba(255,255,255,.10);
      border-radius:14px;background:rgba(255,255,255,.02);cursor:pointer}
    .opt input{margin-top:2px}
    .opt.correct{border-color:rgba(76,255,154,.6);background:rgba(76,255,154,.08)}
    .opt.wrong{border-color:rgba(255,92,122,.6);background:rgba(255,92,122,.08)}
    .inp{width:min(720px,100%);padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);color:var(--text);outline:none}
    .inp:focus{border-color:rgba(77,214,255,.45)}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);color:var(--muted)}
    .tag.good{border-color:rgba(76,255,154,.45);color:rgba(76,255,154,.95)}
    .tag.bad{border-color:rgba(255,92,122,.45);color:rgba(255,92,122,.95)}
    .explain{margin-top:10px;border-top:1px dashed rgba(255,255,255,.14);padding-top:10px;display:none}
    .explain.show{display:block}
    .explain .row{display:grid;gap:6px;padding:8px 10px;border:1px solid rgba(255,255,255,.08);
      border-radius:14px;background:rgba(255,255,255,.02);margin-bottom:8px}
    .toast{position:fixed;right:14px;bottom:14px;max-width:560px;padding:12px 14px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);background:rgba(10,16,30,.86);box-shadow:var(--shadow);display:none;z-index:999}
    .toast.show{display:block}
    .gridIcons{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px;margin-top:10px}
    @media(max-width:760px){.gridIcons{grid-template-columns:repeat(2, minmax(0,1fr));}}
    .iconCard{border:1px solid rgba(255,255,255,.10);border-radius:16px;background:rgba(255,255,255,.02);padding:10px}
    .iconBig{font-size:30px}
    .note{border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.08);border-radius:16px;padding:10px 12px;color:#ffe8b5}
    details summary{cursor:pointer}
    pre{white-space:pre-wrap;margin:8px 0 0 0;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:14px}
    audio{width:min(760px,100%);margin-top:8px}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">U7</div>
      <div>
        <div class="t1">Global Success 7 â€” Unit 7: TRAFFIC (Game Offline)</div>
        <div class="t2">01 file HTML â€¢ xÃ¡o trá»™n Ä‘Ã¡p Ã¡n â€¢ cháº¥m Ä‘iá»ƒm â€¢ giáº£i thÃ­ch + dá»‹ch Viá»‡t â€¢ lÆ°u tiáº¿n Ä‘á»™ â€¢ cháº¿ Ä‘á»™ GV</div>
      </div>
    </div>
    <div class="controls">
      <div class="pill"><span class="small">Thá»i gian</span><span id="timer" class="mono">00:00</span></div>
      <button class="btn" id="btnSave">LÆ°u</button>
      <button class="btn bad" id="btnReset">XÃ³a tiáº¿n Ä‘á»™</button>
      <div class="pill">
        <button class="btn primary" id="btnMusic">Nháº¡c: ON</button>
        <input class="range" id="vol" type="range" min="0" max="100" value="35"/>
      </div>
      <button class="btn warn" id="btnTeacher">Cháº¿ Ä‘á»™ GV</button>
    </div>
  </div>

  <div class="main">
    <aside class="sidebar">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <div style="font-weight:900">Tiáº¿n Ä‘á»™</div>
            <div class="small" id="progressText">0/â€¦ pháº§n â€¢ 0%</div>
          </div>
          <div class="badge" id="scoreBadge">0 Ä‘iá»ƒm</div>
        </div>
        <div class="progressBar"><div id="progressBar"></div></div>
        <div class="kpi">
          <div class="box"><div class="n" id="kCorrect">0</div><div class="l">ÄÃºng</div></div>
          <div class="box"><div class="n" id="kWrong">0</div><div class="l">Sai</div></div>
          <div class="box"><div class="n" id="kPercent">0%</div><div class="l">% Ä‘Ãºng</div></div>
          <div class="box"><div class="n" id="kDone">0%</div><div class="l">HoÃ n thÃ nh</div></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="nav" id="nav"></div>
      <div class="hr"></div>
      <div class="note small">
        Listening: cáº§n thÃªm audio + trang cÃ²n thiáº¿u (Activity 3). Hiá»‡n Ä‘Ã£ cÃ³ khung nghe + náº¡p audio offline.
      </div>
    </aside>

    <section class="content">
      <div class="sectionHeader">
        <div>
          <h2 id="sectionTitle"></h2>
          <div class="sub" id="sectionSub"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn good" id="btnSubmit">Ná»™p bÃ i</button>
          <button class="btn" id="btnExplain">Giáº£i thÃ­ch</button>
          <button class="btn warn" id="btnAnswers">Xem Ä‘Ã¡p Ã¡n</button>
          <button class="btn bad" id="btnRetry">LÃ m láº¡i pháº§n</button>
          <button class="btn primary" id="btnNext">Tiáº¿p theo</button>
        </div>
      </div>

      <div id="stage"></div>

      <div class="hr"></div>
      <div class="card">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900">Xuáº¥t káº¿t quáº£</div>
            <div class="small">Tá»•ng Ä‘iá»ƒm â€¢ % Ä‘Ãºng â€¢ thá»i gian â€¢ chi tiáº¿t theo cÃ¢u</div>
          </div>
          <button class="btn primary" id="btnExport">Xuáº¥t bÃ¡o cÃ¡o</button>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =========================
   0) STORAGE / SETTINGS
========================= */
const TEACHER_CODE = "TEACHER-2026";
const LS_STATE = "GS7_U7_TRAFFIC_STATE_V1";
const LS_SHUF  = "GS7_U7_TRAFFIC_SHUF_V1";
const LS_MUSIC = "GS7_U7_TRAFFIC_MUSIC_V1";
const LS_AUDIO = "GS7_U7_TRAFFIC_AUDIOPACK_V1";

/* =========================
   1) CONTENT (tá»« cÃ¡c trang báº¡n cung cáº¥p)
   - type: mcq | fill | write | match | info | listening
   - answer: vá»›i mcq lÃ  ná»™i dung Ä‘Ã¡p Ã¡n Ä‘Ãºng (khÃ´ng pháº£i A/B/C/D)
========================= */
const CONTENT = [
  {
    key:"GS",
    title:"GETTING STARTED",
    sub:"Meeting in the schoolyard â€¢ Listen and read",
    passage:{
      title:"Dialogue (EN) + Dá»‹ch (VI)",
      textEN:
`Lan: Hi, Mark. How are you?
Mark: Good, thanks. And you?
What did you do last Sunday?
Lan: Iâ€™m fine. Last Sunday afternoon, I cycled round the lake near my home.
Mark: That sounds really healthy.
By the way, do you often cycle to school too?
Lan: Yes, but sometimes my mum takes me on her motorbike.
Mark: How far is it from your home to school?
Lan: Itâ€™s about two kilometres.
Mark: How long does it take you to cycle there?
Lan: About 10 minutes. Sometimes, when there are traffic jams, it takes longer.
Mark: You should be careful, especially when you cross the road.
Lan: Right. The roads get really crowded.
Mark: Hey, how about going cycling round the lake this Sunday?
Lan: Great! Can you come to my house at 3 p.m.?
Mark: OK, Lan. See you then.`,
      textVI:
`Lan: ChÃ o Mark. Báº¡n khá»e khÃ´ng?
Mark: MÃ¬nh khá»e, cáº£m Æ¡n. CÃ²n báº¡n?
Chá»§ nháº­t vá»«a rá»“i báº¡n lÃ m gÃ¬?
Lan: MÃ¬nh á»•n. Chiá»u chá»§ nháº­t tuáº§n trÆ°á»›c, mÃ¬nh Ä‘áº¡p xe vÃ²ng quanh há»“ gáº§n nhÃ .
Mark: Nghe tháº­t lÃ nh máº¡nh.
NhÃ¢n tiá»‡n, báº¡n cÃ³ thÆ°á»ng Ä‘áº¡p xe Ä‘áº¿n trÆ°á»ng khÃ´ng?
Lan: CÃ³, nhÆ°ng Ä‘Ã´i khi máº¹ mÃ¬nh chá»Ÿ mÃ¬nh báº±ng xe mÃ¡y.
Mark: Tá»« nhÃ  báº¡n Ä‘áº¿n trÆ°á»ng xa bao nhiÃªu?
Lan: Khoáº£ng hai ki-lÃ´-mÃ©t.
Mark: Báº¡n máº¥t bao lÃ¢u Ä‘á»ƒ Ä‘áº¡p xe Ä‘áº¿n Ä‘Ã³?
Lan: Khoáº£ng 10 phÃºt. ÄÃ´i khi, khi bá»‹ táº¯c Ä‘Æ°á»ng, sáº½ lÃ¢u hÆ¡n.
Mark: Báº¡n nÃªn cáº©n tháº­n, nháº¥t lÃ  khi bÄƒng qua Ä‘Æ°á»ng.
Lan: ÄÃºng váº­y. ÄÆ°á»ng ráº¥t Ä‘Ã´ng.
Mark: NÃ y, chá»§ nháº­t nÃ y Ä‘i Ä‘áº¡p xe quanh há»“ nhÃ©?
Lan: Tuyá»‡t! Báº¡n cÃ³ thá»ƒ Ä‘áº¿n nhÃ  mÃ¬nh lÃºc 3 giá» chiá»u khÃ´ng?
Mark: ÄÆ°á»£c, Lan. Háº¹n gáº·p báº¡n nhÃ©.`
    },
    items:[
      { id:"GS-2-1", type:"mcq", skill:"Read the conversation again and choose the correct answer.",
        prompt:"How does Lan often go to school?",
        choices:["By bicycle.","By motorbike.","On foot."],
        answer:"By bicycle.",
        explain:"Lan says she often cycles to school.",
        vi:"Lan thÆ°á»ng Ä‘áº¿n trÆ°á»ng báº±ng cÃ¡ch nÃ o? â†’ Báº±ng xe Ä‘áº¡p."},
      { id:"GS-2-2", type:"mcq", skill:"Read the conversation again and choose the correct answer.",
        prompt:"It normally takes Lan _____ to get to school.",
        choices:["two minutes","ten minutes","twenty minutes"],
        answer:"ten minutes",
        explain:"Lan says: â€œAbout 10 minutes.â€",
        vi:"BÃ¬nh thÆ°á»ng Lan máº¥t _____ Ä‘á»ƒ Ä‘áº¿n trÆ°á»ng. â†’ mÆ°á»i phÃºt."},
      { id:"GS-2-3", type:"mcq", skill:"Read the conversation again and choose the correct answer.",
        prompt:"Lan and Mark agree to go cycling _____ .",
        choices:["tomorrow","every day","at the weekend"],
        answer:"at the weekend",
        explain:"They plan to go cycling this Sunday.",
        vi:"Lan vÃ  Mark Ä‘á»“ng Ã½ Ä‘i Ä‘áº¡p xe _____. â†’ vÃ o cuá»‘i tuáº§n."},

      { id:"GS-3-1", type:"fill", skill:"Write one word from the conversation.",
        prompt:"Last Sunday afternoon, Lan ______ round the lake near her home.",
        answer:"cycled",
        explain:"In the dialogue: â€œI cycled round the lake â€¦â€.",
        vi:"Chiá»u chá»§ nháº­t tuáº§n trÆ°á»›c, Lan ______ quanh há»“ gáº§n nhÃ . â†’ cycled (Ä‘áº¡p xe)."},
      { id:"GS-3-2", type:"fill", skill:"Write one word from the conversation.",
        prompt:"Mark says to Lan: â€œYou ______ be careful, especially when you cross the road.â€",
        answer:"should",
        explain:"We use 'should' to give advice.",
        vi:"Mark nÃ³i: â€œBáº¡n ______ cáº©n tháº­nâ€¦â€ â†’ should (nÃªn)."},
      { id:"GS-3-3", type:"fill", skill:"Write one word from the conversation.",
        prompt:"Traffic ______ are a problem in big cities.",
        answer:"jams",
        explain:"In the dialogue: â€œwhen there are traffic jamsâ€¦â€.",
        vi:"Táº¯c Ä‘Æ°á»ng lÃ  váº¥n Ä‘á» á»Ÿ cÃ¡c thÃ nh phá»‘ lá»›n. â†’ jams."},
      { id:"GS-3-4", type:"fill", skill:"Write one word from the conversation.",
        prompt:"______ does your mum go shopping? â€“ She often walks.",
        answer:"How",
        explain:"The question word is 'How' (How does she go?).",
        vi:"______ máº¹ báº¡n Ä‘i mua sáº¯m báº±ng cÃ¡ch nÃ o? â†’ How."},
      { id:"GS-3-5", type:"fill", skill:"Write one word from the conversation.",
        prompt:"This road is very ______ during the rush hours.",
        answer:"crowded",
        explain:"Lan says: â€œThe roads get really crowded.â€",
        vi:"Con Ä‘Æ°á»ng nÃ y ráº¥t ______ vÃ o giá» cao Ä‘iá»ƒm. â†’ crowded (Ä‘Ã´ng Ä‘Ãºc)."},

      { id:"GS-4", type:"info", skill:"Look at the pictures and write a word under each.",
        prompt:"Means of transport (1â€“8). (KhÃ´ng dÃ¹ng áº£nh SGK â€” dÃ¹ng icon thay tháº¿)",
        vi:"NhÃ¬n hÃ¬nh vÃ  viáº¿t tá»« chá»‰ phÆ°Æ¡ng tiá»‡n giao thÃ´ng (1â€“8).",
        data:{
          icons:[
            {n:1, icon:"ğŸš²", labelEN:"bicycle", labelVI:"xe Ä‘áº¡p"},
            {n:2, icon:"ğŸš—", labelEN:"car", labelVI:"Ã´ tÃ´"},
            {n:3, icon:"ğŸšŒ", labelEN:"bus", labelVI:"xe buÃ½t"},
            {n:4, icon:"ğŸï¸", labelEN:"motorbike", labelVI:"xe mÃ¡y"},
            {n:5, icon:"âœˆï¸", labelEN:"plane", labelVI:"mÃ¡y bay"},
            {n:6, icon:"ğŸš†", labelEN:"train", labelVI:"tÃ u há»a"},
            {n:7, icon:"ğŸš¤", labelEN:"boat", labelVI:"thuyá»n"},
            {n:8, icon:"ğŸ›³ï¸", labelEN:"ship", labelVI:"tÃ u (lá»›n)"}
          ]
        }
      },
      { id:"GS-4-1", type:"fill", skill:"Transport vocabulary",
        prompt:"1. ğŸš²",
        answer:"bicycle",
        explain:"Bicycle = xe Ä‘áº¡p.",
        vi:"1. ğŸš² â†’ bicycle (xe Ä‘áº¡p)."},
      { id:"GS-4-2", type:"fill", skill:"Transport vocabulary",
        prompt:"2. ğŸš—",
        answer:"car",
        explain:"Car = Ã´ tÃ´.",
        vi:"2. ğŸš— â†’ car (Ã´ tÃ´)."},
      { id:"GS-4-3", type:"fill", skill:"Transport vocabulary",
        prompt:"3. ğŸšŒ",
        answer:"bus",
        explain:"Bus = xe buÃ½t.",
        vi:"3. ğŸšŒ â†’ bus (xe buÃ½t)."},
      { id:"GS-4-4", type:"fill", skill:"Transport vocabulary",
        prompt:"4. ğŸï¸",
        answer:"motorbike",
        explain:"Motorbike = xe mÃ¡y.",
        vi:"4. ğŸï¸ â†’ motorbike (xe mÃ¡y)."},
      { id:"GS-4-5", type:"fill", skill:"Transport vocabulary",
        prompt:"5. âœˆï¸",
        answer:"plane",
        explain:"Plane = mÃ¡y bay.",
        vi:"5. âœˆï¸ â†’ plane (mÃ¡y bay)."},
      { id:"GS-4-6", type:"fill", skill:"Transport vocabulary",
        prompt:"6. ğŸš†",
        answer:"train",
        explain:"Train = tÃ u há»a.",
        vi:"6. ğŸš† â†’ train (tÃ u há»a)."},
      { id:"GS-4-7", type:"fill", skill:"Transport vocabulary",
        prompt:"7. ğŸš¤",
        answer:"boat",
        explain:"Boat = thuyá»n.",
        vi:"7. ğŸš¤ â†’ boat (thuyá»n)."},
      { id:"GS-4-8", type:"fill", skill:"Transport vocabulary",
        prompt:"8. ğŸ›³ï¸",
        answer:"ship",
        explain:"Ship = tÃ u lá»›n.",
        vi:"8. ğŸ›³ï¸ â†’ ship (tÃ u lá»›n)."}
    ]
  },

  {
    key:"CL1",
    title:"A CLOSER LOOK 1",
    sub:"Vocabulary â€¢ Road signs",
    items:[
      { id:"CL1-1", type:"match", skill:"Vocabulary: Match A with B",
        prompt:"Match the words in A with the phrases in B.",
        vi:"Ná»‘i cÃ¡c tá»« á»Ÿ cá»™t A vá»›i cá»¥m tá»« á»Ÿ cá»™t B.",
        data:{
          left:[
            {k:"1", text:"ride"},
            {k:"2", text:"drive"},
            {k:"3", text:"sail"},
            {k:"4", text:"go"},
            {k:"5", text:"travel"}
          ],
          right:[
            {k:"a", text:"a car"},
            {k:"b", text:"a boat"},
            {k:"c", text:"a bike"},
            {k:"d", text:"by air"},
            {k:"e", text:"on foot"}
          ]
        },
        answer:{ "1":"c", "2":"a", "3":"b", "4":"e", "5":"d" },
        explain:"Collocations: ride a bike; drive a car; sail a boat; go on foot; travel by air.",
        vi_explain:"Cá»¥m tá»« cá»‘ Ä‘á»‹nh: ride a bike; drive a car; sail a boat; go on foot; travel by air."
      },

      { id:"CL1-2", type:"info", skill:"Road signs",
        prompt:"Look at these road signs. Then write the correct phrases under the signs.",
        vi:"NhÃ¬n cÃ¡c biá»ƒn bÃ¡o vÃ  viáº¿t Ä‘Ãºng cá»¥m tá»« dÆ°á»›i má»—i biá»ƒn.",
        data:{
          phrases:["No right turn","Cycle lane","School ahead","Traffic lights","No cycling","Hospital ahead"],
          signs:[
            {n:1, icon:"ğŸš¦", hint:"Traffic lights"},
            {n:2, icon:"ğŸ¥â¡ï¸", hint:"Hospital ahead"},
            {n:3, icon:"â†ªï¸ğŸš«", hint:"No right turn"},
            {n:4, icon:"ğŸš²ğŸ›£ï¸", hint:"Cycle lane"},
            {n:5, icon:"ğŸ«â¡ï¸", hint:"School ahead"},
            {n:6, icon:"ğŸš²ğŸš«", hint:"No cycling"}
          ]
        }
      },
      { id:"CL1-2-1", type:"fill", skill:"Road signs",
        prompt:"1. ğŸš¦",
        answer:"Traffic lights",
        explain:"The sign shows traffic lights.",
        vi:"1. ğŸš¦ â†’ Traffic lights (Ä‘Ã¨n giao thÃ´ng)."},
      { id:"CL1-2-2", type:"fill", skill:"Road signs",
        prompt:"2. ğŸ¥â¡ï¸",
        answer:"Hospital ahead",
        explain:"Hospital ahead = phÃ­a trÆ°á»›c cÃ³ bá»‡nh viá»‡n.",
        vi:"2. ğŸ¥â¡ï¸ â†’ Hospital ahead (bá»‡nh viá»‡n phÃ­a trÆ°á»›c)."},
      { id:"CL1-2-3", type:"fill", skill:"Road signs",
        prompt:"3. â†ªï¸ğŸš«",
        answer:"No right turn",
        explain:"No right turn = cáº¥m ráº½ pháº£i.",
        vi:"3. â†ªï¸ğŸš« â†’ No right turn (cáº¥m ráº½ pháº£i)."},
      { id:"CL1-2-4", type:"fill", skill:"Road signs",
        prompt:"4. ğŸš²ğŸ›£ï¸",
        answer:"Cycle lane",
        explain:"Cycle lane = lÃ n Ä‘Æ°á»ng xe Ä‘áº¡p.",
        vi:"4. ğŸš²ğŸ›£ï¸ â†’ Cycle lane (lÃ n xe Ä‘áº¡p)."},
      { id:"CL1-2-5", type:"fill", skill:"Road signs",
        prompt:"5. ğŸ«â¡ï¸",
        answer:"School ahead",
        explain:"School ahead = phÃ­a trÆ°á»›c cÃ³ trÆ°á»ng há»c.",
        vi:"5. ğŸ«â¡ï¸ â†’ School ahead (trÆ°á»ng há»c phÃ­a trÆ°á»›c)."},
      { id:"CL1-2-6", type:"fill", skill:"Road signs",
        prompt:"6. ğŸš²ğŸš«",
        answer:"No cycling",
        explain:"No cycling = cáº¥m Ä‘i xe Ä‘áº¡p.",
        vi:"6. ğŸš²ğŸš« â†’ No cycling (cáº¥m xe Ä‘áº¡p)."}
    ]
  },

  {
    key:"CL2",
    title:"A CLOSER LOOK 2",
    sub:"Grammar â€¢ It indicating distance â€¢ should/shouldnâ€™t",
    items:[
      { id:"CL2-IT-0", type:"info", skill:"Grammar",
        prompt:"We can use It in the position of the subject to indicate distance. Example: It is about 300 metres from my house to the bus stop.",
        vi:"Ta dÃ¹ng 'It' lÃ m chá»§ ngá»¯ Ä‘á»ƒ nÃ³i vá» khoáº£ng cÃ¡ch. VD: It is about 300 metres from my house to the bus stop.",
        data:{} },

      { id:"CL2-IT-1", type:"write", skill:"Write sentences with It (Use the cues).",
        prompt:"1) 700 metres / my flat / Youth Club",
        answer:"It is about 700 metres from my flat to the Youth Club.",
        explain:"Form: It + be + (about) + distance + from A + to B.",
        vi:"Viáº¿t cÃ¢u vá»›i 'It': It is about 700 metres from my flat to the Youth Club. (Khoáº£ng 700m tá»« cÄƒn há»™ cá»§a tÃ´i Ä‘áº¿n CÃ¢u láº¡c bá»™ Thanh thiáº¿u niÃªn).",
        data:{hintEN:"It is about ... metres from ... to ..."} },

      { id:"CL2-IT-2", type:"write", skill:"Write sentences with It (Use the cues).",
        prompt:"2) 5 kilometres (km) / my village / nearest town",
        answer:"It is about 5 kilometres from my village to the nearest town.",
        explain:"Use 'kilometres' for long distance.",
        vi:"It is about 5 kilometres from my village to the nearest town. (Khoáº£ng 5km tá»« lÃ ng tÃ´i Ä‘áº¿n thá»‹ tráº¥n gáº§n nháº¥t).",
        data:{hintEN:"It is about ... kilometres from ... to ..."} },

      { id:"CL2-IT-3", type:"write", skill:"Write sentences with It (Use the cues).",
        prompt:"3) about 120 km / Ho Chi Minh City / Vung Tau",
        answer:"It is about 120 km from Ho Chi Minh City to Vung Tau.",
        explain:"Keep 'about' when the distance is approximate.",
        vi:"It is about 120 km from Ho Chi Minh City to Vung Tau. (Khoáº£ng 120km tá»« TP.HCM Ä‘áº¿n VÅ©ng TÃ u).",
        data:{hintEN:"It is about ... km from ... to ..."} },

      { id:"CL2-IT-4", type:"write", skill:"Write sentences with It (Use the cues).",
        prompt:"4) 384,400 km / the Earth / the Moon",
        answer:"It is about 384,400 km from the Earth to the Moon.",
        explain:"Scientific distance can still use the same pattern.",
        vi:"It is about 384,400 km from the Earth to the Moon. (Khoáº£ng 384.400km tá»« TrÃ¡i Äáº¥t Ä‘áº¿n Máº·t TrÄƒng).",
        data:{hintEN:"It is about ... km from ... to ..."} },

      { id:"CL2-IT-5", type:"write", skill:"Write sentences with It (Use the cues).",
        prompt:"5) not very far / Ha Noi centre / Noi Bai Airport",
        answer:"It is not very far from Ha Noi centre to Noi Bai Airport.",
        explain:"Negative: It is not very far from A to B.",
        vi:"It is not very far from Ha Noi centre to Noi Bai Airport. (KhÃ´ng quÃ¡ xa tá»« trung tÃ¢m HÃ  Ná»™i Ä‘áº¿n sÃ¢n bay Ná»™i BÃ i).",
        data:{hintEN:"It is not very far from ... to ..."} },

      { id:"CL2-SS-1", type:"mcq", skill:"Should / shouldnâ€™t: Choose the correct option.",
        prompt:"1) Thatâ€™s an interesting book. You (should / shouldnâ€™t) read it.",
        choices:["should","shouldnâ€™t"],
        answer:"should",
        explain:"'Should' gives advice: you are recommended to read it.",
        vi:"ÄÃ³ lÃ  cuá»‘n sÃ¡ch thÃº vá»‹. Báº¡n (nÃªn/khÃ´ng nÃªn) Ä‘á»c. â†’ should (nÃªn)."},
      { id:"CL2-SS-2", type:"mcq", skill:"Should / shouldnâ€™t: Choose the correct option.",
        prompt:"2) You nearly fell off your bike! You really (should / shouldnâ€™t) be more careful.",
        choices:["should","shouldnâ€™t"],
        answer:"should",
        explain:"Nearly fell â†’ need advice to be more careful.",
        vi:"Báº¡n suÃ½t ngÃ£ khá»i xe Ä‘áº¡p! Báº¡n tháº­t sá»± (nÃªn/khÃ´ng nÃªn) cáº©n tháº­n hÆ¡n. â†’ should."},
      { id:"CL2-SS-3", type:"mcq", skill:"Should / shouldnâ€™t: Choose the correct option.",
        prompt:"3) We (should / shouldnâ€™t) go swimming right after eating.",
        choices:["should","shouldnâ€™t"],
        answer:"shouldnâ€™t",
        explain:"Right after eating is not a good idea â†’ negative advice.",
        vi:"ChÃºng ta (nÃªn/khÃ´ng nÃªn) bÆ¡i ngay sau khi Äƒn. â†’ shouldnâ€™t."},
      { id:"CL2-SS-4", type:"mcq", skill:"Should / shouldnâ€™t: Choose the correct option.",
        prompt:"4) I think that he (should / shouldnâ€™t) eat less. Heâ€™s becoming overweight.",
        choices:["should","shouldnâ€™t"],
        answer:"should",
        explain:"Overweight â†’ advice: eat less.",
        vi:"MÃ¬nh nghÄ© anh áº¥y (nÃªn/khÃ´ng nÃªn) Äƒn Ã­t láº¡i. Anh áº¥y Ä‘ang thá»«a cÃ¢n. â†’ should."},
      { id:"CL2-SS-5", type:"mcq", skill:"Should / shouldnâ€™t: Choose the correct option.",
        prompt:"5) There are a lot of cars out today. He (should / shouldnâ€™t) drive so fast.",
        choices:["should","shouldnâ€™t"],
        answer:"shouldnâ€™t",
        explain:"Many cars â†’ donâ€™t drive fast (negative advice).",
        vi:"HÃ´m nay nhiá»u xe. Anh áº¥y (nÃªn/khÃ´ng nÃªn) lÃ¡i nhanh nhÆ° váº­y. â†’ shouldnâ€™t."},

      { id:"CL2-4-1", type:"fill", skill:"Complete each sentence using should / shouldnâ€™t.",
        prompt:"1) We ______ ride our motorbikes very fast in the rain.",
        answer:"shouldnâ€™t",
        explain:"Rainy â†’ unsafe â†’ shouldnâ€™t.",
        vi:"ChÃºng ta ______ cháº¡y xe mÃ¡y ráº¥t nhanh khi trá»i mÆ°a. â†’ shouldnâ€™t."},
      { id:"CL2-4-2", type:"fill", skill:"Complete each sentence using should / shouldnâ€™t.",
        prompt:"2) You ______ study instead of watching YouTube.",
        answer:"should",
        explain:"Advice: study instead.",
        vi:"Báº¡n ______ há»c thay vÃ¬ xem YouTube. â†’ should."},
      { id:"CL2-4-3", type:"fill", skill:"Complete each sentence using should / shouldnâ€™t.",
        prompt:"3) My little sister ______ play outside late at night.",
        answer:"shouldnâ€™t",
        explain:"Late at night â†’ not safe.",
        vi:"Em gÃ¡i tÃ´i ______ chÆ¡i bÃªn ngoÃ i vÃ o Ä‘Ãªm muá»™n. â†’ shouldnâ€™t."},
      { id:"CL2-4-4", type:"fill", skill:"Complete each sentence using should / shouldnâ€™t.",
        prompt:"4) You ______ help your mum wash the dishes after dinner.",
        answer:"should",
        explain:"Advice/ responsibility.",
        vi:"Báº¡n ______ giÃºp máº¹ rá»­a bÃ¡t sau bá»¯a tá»‘i. â†’ should."},
      { id:"CL2-4-5", type:"fill", skill:"Complete each sentence using should / shouldnâ€™t.",
        prompt:"5) You look tired. You ______ probably get some sleep.",
        answer:"should",
        explain:"Tired â†’ advice: get some sleep.",
        vi:"Báº¡n trÃ´ng má»‡t. Báº¡n ______ cÃ³ láº½ nÃªn ngá»§ má»™t chÃºt. â†’ should."},
      { id:"CL2-4-6", type:"fill", skill:"Complete each sentence using should / shouldnâ€™t.",
        prompt:"6) The children ______ eat so much ice cream.",
        answer:"shouldnâ€™t",
        explain:"Too much ice cream is not good.",
        vi:"Tráº» con ______ Äƒn quÃ¡ nhiá»u kem. â†’ shouldnâ€™t."},

      { id:"CL2-5-1", type:"write", skill:"Look at the pictures. Make sentences using should/shouldnâ€™t and the cues.",
        prompt:"1) waste water",
        answer:["We shouldnâ€™t waste water.","You shouldnâ€™t waste water."],
        explain:"Negative advice with shouldnâ€™t.",
        vi:"KhÃ´ng nÃªn lÃ£ng phÃ­ nÆ°á»›c. â†’ We/You shouldnâ€™t waste water.",
        data:{hintEN:"(We/You) shouldnâ€™t ...", sampleEN:"We shouldnâ€™t waste water.", sampleVI:"ChÃºng ta khÃ´ng nÃªn lÃ£ng phÃ­ nÆ°á»›c."}},
      { id:"CL2-5-2", type:"write", skill:"Look at the pictures. Make sentences using should/shouldnâ€™t and the cues.",
        prompt:"2) wear their helmets",
        answer:["They should wear their helmets.","We should wear our helmets."],
        explain:"Safety advice: should.",
        vi:"NÃªn Ä‘á»™i mÅ© báº£o hiá»ƒm. â†’ They should wear their helmets.",
        data:{hintEN:"They should ...", sampleEN:"They should wear their helmets.", sampleVI:"Há» nÃªn Ä‘á»™i mÅ© báº£o hiá»ƒm."}},
      { id:"CL2-5-3", type:"write", skill:"Look at the pictures. Make sentences using should/shouldnâ€™t and the cues.",
        prompt:"3) be more careful",
        answer:["She should be more careful.","He should be more careful.","We should be more careful."],
        explain:"Advice: should be more careful.",
        vi:"NÃªn cáº©n tháº­n hÆ¡n. â†’ should be more careful.",
        data:{hintEN:"(He/She/We) should be more careful.", sampleEN:"She should be more careful.", sampleVI:"CÃ´ áº¥y nÃªn cáº©n tháº­n hÆ¡n."}},
      { id:"CL2-5-4", type:"write", skill:"Look at the pictures. Make sentences using should/shouldnâ€™t and the cues.",
        prompt:"4) play football on the pavement",
        answer:["They shouldnâ€™t play football on the pavement.","We shouldnâ€™t play football on the pavement."],
        explain:"Pavement/sidewalk is unsafe for playing football.",
        vi:"KhÃ´ng nÃªn Ä‘Ã¡ bÃ³ng trÃªn vá»‰a hÃ¨. â†’ shouldnâ€™t.",
        data:{hintEN:"They shouldnâ€™t ...", sampleEN:"They shouldnâ€™t play football on the pavement.", demonstrate:1}},
      { id:"CL2-5-5", type:"write", skill:"Look at the pictures. Make sentences using should/shouldnâ€™t and the cues.",
        prompt:"5) ride their bikes dangerously",
        answer:["They shouldnâ€™t ride their bikes dangerously.","We shouldnâ€™t ride our bikes dangerously."],
        explain:"Dangerous riding is not safe.",
        vi:"KhÃ´ng nÃªn Ä‘áº¡p xe nguy hiá»ƒm. â†’ shouldnâ€™t.",
        data:{hintEN:"They shouldnâ€™t ...", sampleEN:"They shouldnâ€™t ride their bikes dangerously.", sampleVI:"Há» khÃ´ng nÃªn Ä‘áº¡p xe nguy hiá»ƒm."}}
    ]
  },

  {
    key:"LIS",
    title:"SKILLS â€” LISTENING (KHUNG)",
    sub:"Náº¡p audio offline + lÃ m cÃ¢u nghe â€¢ (Thiáº¿u Activity 3 trong áº£nh báº¡n gá»­i)",
    items:[
      { id:"LIS-0", type:"listening", skill:"Listening",
        prompt:"Náº¡p file nghe Unit 7 (mp3/m4a) Ä‘á»ƒ há»c sinh nghe offline.",
        vi:"Náº¡p audio Ä‘á»ƒ lÃ m pháº§n nghe (offline).",
        data:{ audioId:"U7_LISTENING_AUDIO_1" } },

      { id:"LIS-4", type:"info", skill:"From the page you sent (Activity 4â€“5)",
        prompt:"Listen and check your answers in 3. Then listen again and complete the sentence with no more than THREE words.",
        vi:"Nghe vÃ  kiá»ƒm tra Ä‘Ã¡p Ã¡n á»Ÿ bÃ i 3. Sau Ä‘Ã³ nghe láº¡i vÃ  hoÃ n thÃ nh cÃ¢u vá»›i khÃ´ng quÃ¡ 3 tá»«.",
        data:{} },

      { id:"LIS-4-1", type:"fill", skill:"Listening (placeholder)",
        prompt:"One explanation is that some countries use ______ as the UK.  [Cáº¦N TRANG/ AUDIO]",
        answer:"[Cáº¦N TRANG/ AUDIO]",
        explain:"Thiáº¿u dá»¯ liá»‡u Activity 3 + audio trong áº£nh hiá»‡n táº¡i.",
        vi:"Thiáº¿u trang bÃ i 3 vÃ  audio: báº¡n gá»­i thÃªm Ä‘á»ƒ Ä‘iá»n chÃ­nh xÃ¡c."},

      { id:"LIS-4-2", type:"info", skill:"Reading/Discussion (Activity 5)",
        prompt:"Read the strange driving rules below. Work in groups. Which one do you think is the strangest?",
        vi:"Äá»c cÃ¡c luáº­t lÃ¡i xe láº¡. Tháº£o luáº­n: luáº­t nÃ o láº¡ nháº¥t?",
        data:{} },

      { id:"LIS-5-1", type:"mcq", skill:"Check understanding of the strange driving rules",
        prompt:"In Alaska, you are (allowed / not allowed) to drive with a dog on the roof of your car.",
        choices:["allowed","not allowed"],
        answer:"not allowed",
        explain:"The rule says: â€œyou are not allowed to drive with a dog on the roof of your car.â€",
        vi:"á» Alaska, báº¡n (Ä‘Æ°á»£c phÃ©p/khÃ´ng Ä‘Æ°á»£c phÃ©p) lÃ¡i xe khi cÃ³ chÃ³ trÃªn nÃ³c xe. â†’ not allowed."},

      { id:"LIS-5-2", type:"mcq", skill:"Check understanding of the strange driving rules",
        prompt:"In Switzerland, you (can / canâ€™t) wash your car on Sunday.",
        choices:["can","canâ€™t"],
        answer:"canâ€™t",
        explain:"The rule says: â€œyou canâ€™t wash your car on Sunday.â€",
        vi:"á» Thá»¥y SÄ©, báº¡n (cÃ³ thá»ƒ/khÃ´ng thá»ƒ) rá»­a xe vÃ o Chá»§ nháº­t. â†’ canâ€™t."},

      { id:"LIS-5-3", type:"mcq", skill:"Check understanding of the strange driving rules",
        prompt:"In Wisconsin, USA, you must always ride your bike with your hands on the ______.",
        choices:["handlebars","headlights","seatbelts"],
        answer:"handlebars",
        explain:"The rule says: â€œwith your hands on the handlebars.â€",
        vi:"á» Wisconsin (Má»¹), báº¡n pháº£i luÃ´n Ä‘áº¡p xe vá»›i tay Ä‘áº·t trÃªn _____. â†’ handlebars (tay lÃ¡i)."}
    ]
  },

  {
    key:"SK1",
    title:"SKILLS 1 â€” READING / SPEAKING",
    sub:"Traffic rules â€¢ Road safety",
    items:[
      { id:"SK1-1", type:"info", skill:"Reading",
        prompt:"Look at the picture. Can you see anything that is dangerous? (Tráº£ lá»i tá»± do, khÃ´ng tÃ­nh Ä‘iá»ƒm)",
        vi:"NhÃ¬n tranh. Em tháº¥y Ä‘iá»u gÃ¬ nguy hiá»ƒm khÃ´ng? (Tráº£ lá»i tá»± do)",
        data:{} },

      { id:"SK1-2", type:"mcq", skill:"Read the following text and choose the correct answer.",
        prompt:"This text is about ______ .",
        choices:["rules for pedestrians","traffic lights","traffic rules"],
        answer:"traffic rules",
        explain:"The text lists rules for pedestrians, cyclists, passengers â†’ traffic rules.",
        vi:"BÃ i Ä‘á»c nÃ³i vá» _____. â†’ traffic rules (luáº­t giao thÃ´ng)."},

      { id:"SK1-TEXT", type:"info", skill:"Text (EN + VI)",
        prompt:"Read the text (Traffic rules).",
        vi:"Äá»c Ä‘oáº¡n vÄƒn (Luáº­t giao thÃ´ng).",
        data:{
          textEN:
`These are some rules about road safety. It is important to obey these rules when you are a road user.

Pedestrians
1. Always look carefully when you cross the street.
2. Use the pavement or footpath.
3. Walk across the street at the zebra crossing.
4. Donâ€™t cross the road on a red light.

Cyclists
1. Always keep both hands on the handlebars.
2. Wear helmets, and always use the cycle lane.
3. Give a signal before you turn.
4. Donâ€™t carry more than one passenger.

Passengers
1. Fasten your seatbelt when you are in a car.
2. Wait for buses to fully stop before getting on or off.
3. Donâ€™t talk to the driver when he / she is driving.
4. Donâ€™t stick any body parts out of the window of a moving vehicle.`,
          textVI:
`ÄÃ¢y lÃ  má»™t sá»‘ quy táº¯c vá» an toÃ n giao thÃ´ng. Khi lÃ  ngÆ°á»i tham gia giao thÃ´ng, em cáº§n tuÃ¢n thá»§ cÃ¡c quy táº¯c nÃ y.

NgÆ°á»i Ä‘i bá»™
1. LuÃ´n quan sÃ¡t cáº©n tháº­n khi bÄƒng qua Ä‘Æ°á»ng.
2. Äi trÃªn vá»‰a hÃ¨/Ä‘Æ°á»ng dÃ nh cho ngÆ°á»i Ä‘i bá»™.
3. BÄƒng qua Ä‘Æ°á»ng táº¡i váº¡ch qua Ä‘Æ°á»ng (zebra crossing).
4. KhÃ´ng bÄƒng qua Ä‘Æ°á»ng khi Ä‘Ã¨n Ä‘á».

NgÆ°á»i Ä‘i xe Ä‘áº¡p
1. LuÃ´n giá»¯ cáº£ hai tay trÃªn tay lÃ¡i.
2. Äá»™i mÅ© báº£o hiá»ƒm vÃ  luÃ´n Ä‘i Ä‘Ãºng lÃ n xe Ä‘áº¡p.
3. Ra tÃ­n hiá»‡u trÆ°á»›c khi ráº½.
4. KhÃ´ng chá»Ÿ quÃ¡ má»™t ngÆ°á»i.

HÃ nh khÃ¡ch
1. Tháº¯t dÃ¢y an toÃ n khi ngá»“i trong Ã´ tÃ´.
2. Chá» xe buÃ½t dá»«ng háº³n rá»“i má»›i lÃªn/xuá»‘ng.
3. KhÃ´ng nÃ³i chuyá»‡n lÃ m phÃ¢n tÃ¢m ngÆ°á»i lÃ¡i xe.
4. KhÃ´ng thÃ² báº¥t ká»³ bá»™ pháº­n nÃ o ra ngoÃ i cá»­a sá»• khi xe Ä‘ang cháº¡y.`
        }
      },

      { id:"SK1-3-1", type:"fill", skill:"Read the text again and answer the questions.",
        prompt:"1) Where should pedestrians cross the street?",
        answer:"at the zebra crossing",
        explain:"Pedestrians rule #3: walk across at the zebra crossing.",
        vi:"NgÆ°á»i Ä‘i bá»™ nÃªn qua Ä‘Æ°á»ng á»Ÿ Ä‘Ã¢u? â†’ at the zebra crossing (váº¡ch qua Ä‘Æ°á»ng)."},
      { id:"SK1-3-2", type:"fill", skill:"Read the text again and answer the questions.",
        prompt:"2) Which lane should you use when riding a bike?",
        answer:"the cycle lane",
        explain:"Cyclists rule #2: always use the cycle lane.",
        vi:"Äi xe Ä‘áº¡p nÃªn Ä‘i lÃ n nÃ o? â†’ the cycle lane (lÃ n xe Ä‘áº¡p)."},
      { id:"SK1-3-3", type:"fill", skill:"Read the text again and answer the questions.",
        prompt:"3) What should you do before you turn while riding a bike?",
        answer:"give a signal",
        explain:"Cyclists rule #3: give a signal before you turn.",
        vi:"TrÆ°á»›c khi ráº½ khi Ä‘i xe Ä‘áº¡p, em nÃªn lÃ m gÃ¬? â†’ give a signal (ra tÃ­n hiá»‡u)."},
      { id:"SK1-3-4", type:"fill", skill:"Read the text again and answer the questions.",
        prompt:"4) What must you do when you get on or off a bus?",
        answer:"wait for it to fully stop",
        explain:"Passengers rule #2: wait for buses to fully stop.",
        vi:"Khi lÃªn/xuá»‘ng xe buÃ½t, em pháº£i lÃ m gÃ¬? â†’ wait for it to fully stop (chá» dá»«ng háº³n)."},
      { id:"SK1-3-5", type:"fill", skill:"Read the text again and answer the questions.",
        prompt:"5) What mustnâ€™t you do when you are in a moving vehicle?",
        answer:"stick any body parts out of the window",
        explain:"Passengers rule #4: donâ€™t stick body parts out of the window.",
        vi:"Khi xe Ä‘ang cháº¡y, em khÃ´ng Ä‘Æ°á»£c lÃ m gÃ¬? â†’ stick body parts out of the window (thÃ² tay/chÃ¢n ra ngoÃ i)."}
      ,

      { id:"SK1-4", type:"info", skill:"Speaking",
        prompt:"Work in groups. Ask and answer: When you are a road user, what should YOU NOT do?",
        vi:"LÃ m viá»‡c nhÃ³m: Khi tham gia giao thÃ´ng, em KHÃ”NG nÃªn lÃ m gÃ¬?",
        data:{} },

      { id:"SK1-5", type:"mcq", skill:"Discuss: who is being safe?",
        prompt:"1) Hoang is riding a bike, and he is wearing a helmet.",
        choices:["safe","not safe"],
        answer:"safe",
        explain:"Wearing a helmet is safe.",
        vi:"HoÃ ng Ä‘i xe Ä‘áº¡p vÃ  Ä‘á»™i mÅ© báº£o hiá»ƒm â†’ an toÃ n."},
      { id:"SK1-5-2", type:"mcq", skill:"Discuss: who is being safe?",
        prompt:"2) It is raining hard, but Mr Long is driving quickly.",
        choices:["safe","not safe"],
        answer:"not safe",
        explain:"Driving fast in heavy rain is dangerous.",
        vi:"Trá»i mÆ°a to mÃ  lÃ¡i nhanh â†’ khÃ´ng an toÃ n."},
      { id:"SK1-5-3", type:"mcq", skill:"Discuss: who is being safe?",
        prompt:"3) The students are standing in a line to get on the school bus.",
        choices:["safe","not safe"],
        answer:"safe",
        explain:"Standing in a line is orderly and safe.",
        vi:"Xáº¿p hÃ ng lÃªn xe buÃ½t â†’ an toÃ n."},
      { id:"SK1-5-4", type:"mcq", skill:"Discuss: who is being safe?",
        prompt:"4) Mr Binh is taking his daughter to school on his motorbike. She is sitting in front of him.",
        choices:["safe","not safe"],
        answer:"not safe",
        explain:"A child sitting in front can be unsafe; child should be secured and wear a helmet.",
        vi:"Chá»Ÿ con ngá»“i phÃ­a trÆ°á»›c xe mÃ¡y â†’ khÃ´ng an toÃ n."},
      { id:"SK1-5-5", type:"mcq", skill:"Discuss: who is being safe?",
        prompt:"5) Michelle is cycling to school and she is waving and shouting to her friends.",
        choices:["safe","not safe"],
        answer:"not safe",
        explain:"Waving/shouting can distract and cause accidents.",
        vi:"Vá»«a Ä‘áº¡p xe vá»«a váº«y tay, la hÃ©t â†’ khÃ´ng an toÃ n."}
    ]
  },

  {
    key:"LB",
    title:"LOOKING BACK",
    sub:"Vocabulary + Grammar",
    items:[
      { id:"LB-1", type:"info", skill:"Vocabulary",
        prompt:"Label each sign. (DÃ¹ng icon thay tháº¿)",
        vi:"Gá»i tÃªn cÃ¡c biá»ƒn bÃ¡o (dÃ¹ng icon thay tháº¿).",
        data:{} },

      { id:"LB-1-1", type:"fill", skill:"Vocabulary: Signs",
        prompt:"1) ğŸš¦ (red light sign)",
        answer:"Traffic lights",
        explain:"Traffic lights = Ä‘Ã¨n giao thÃ´ng.",
        vi:"1) ğŸš¦ â†’ Traffic lights."},
      { id:"LB-1-2", type:"fill", skill:"Vocabulary: Signs",
        prompt:"2) ğŸ«â¡ï¸",
        answer:"School ahead",
        explain:"School ahead = phÃ­a trÆ°á»›c cÃ³ trÆ°á»ng.",
        vi:"2) ğŸ«â¡ï¸ â†’ School ahead."},
      { id:"LB-1-3", type:"fill", skill:"Vocabulary: Signs",
        prompt:"3) ğŸ¥â¡ï¸",
        answer:"Hospital ahead",
        explain:"Hospital ahead = phÃ­a trÆ°á»›c cÃ³ bá»‡nh viá»‡n.",
        vi:"3) ğŸ¥â¡ï¸ â†’ Hospital ahead."},
      { id:"LB-1-4", type:"fill", skill:"Vocabulary: Signs",
        prompt:"4) ğŸš²ğŸ›£ï¸",
        answer:"Cycle lane",
        explain:"Cycle lane = lÃ n xe Ä‘áº¡p.",
        vi:"4) ğŸš²ğŸ›£ï¸ â†’ Cycle lane."},
      { id:"LB-1-5", type:"fill", skill:"Vocabulary: Signs",
        prompt:"5) â†ªï¸ğŸš«",
        answer:"No right turn",
        explain:"No right turn = cáº¥m ráº½ pháº£i.",
        vi:"5) â†ªï¸ğŸš« â†’ No right turn."},
      { id:"LB-1-6", type:"fill", skill:"Vocabulary: Signs",
        prompt:"6) ğŸš²ğŸš«",
        answer:"No cycling",
        explain:"No cycling = cáº¥m xe Ä‘áº¡p.",
        vi:"6) ğŸš²ğŸš« â†’ No cycling."},

      { id:"LB-2-1", type:"fill", skill:"Fill in each gap with one word.",
        prompt:"1) A road ______ is anyone who uses a road, such as a pedestrian, cyclist or motorist.",
        answer:"user",
        explain:"Road user = ngÆ°á»i tham gia giao thÃ´ng.",
        vi:"1) A road ______ â€¦ â†’ user."},
      { id:"LB-2-2", type:"fill", skill:"Fill in each gap with one word.",
        prompt:"2) Does your dad ______ his motorbike carefully?",
        answer:"ride",
        explain:"We ride a motorbike/bike.",
        vi:"2) Does your dad ______ â€¦ â†’ ride."},
      { id:"LB-2-3", type:"fill", skill:"Fill in each gap with one word.",
        prompt:"3) A ______ is a person travelling in a car, bus, train, â€¦ but not driving.",
        answer:"passenger",
        explain:"Passenger = hÃ nh khÃ¡ch.",
        vi:"3) A ______ â€¦ â†’ passenger."},
      { id:"LB-2-4", type:"fill", skill:"Fill in each gap with one word.",
        prompt:"4) My cousin wants to become a pilot. He is learning to ______ planes.",
        answer:"fly",
        explain:"Pilots fly planes.",
        vi:"4) learning to ______ planes â†’ fly."},
      { id:"LB-2-5", type:"fill", skill:"Fill in each gap with one word.",
        prompt:"5) We should be careful when the ______ light is yellow.",
        answer:"traffic",
        explain:"Traffic light = Ä‘Ã¨n giao thÃ´ng.",
        vi:"5) the ______ light â†’ traffic."},

      { id:"LB-3-1", type:"write", skill:"Grammar: It indicating distance (Write complete sentences).",
        prompt:"1) over 100 km / my home town / Ho Chi Minh City",
        answer:"It is over 100 km from my home town to Ho Chi Minh City.",
        explain:"It + be + distance + from A + to B.",
        vi:"It is over 100 km from my home town to Ho Chi Minh City. (HÆ¡n 100km tá»« quÃª tÃ´i Ä‘áº¿n TP.HCM).",
        data:{hintEN:"It is ... km from ... to ..."} },
      { id:"LB-3-2", type:"write", skill:"Grammar: It indicating distance (Write complete sentences).",
        prompt:"2) about 25 km / here / my grandparentsâ€™ house",
        answer:"It is about 25 km from here to my grandparentsâ€™ house.",
        explain:"Use 'from here to ...' when starting point is here.",
        vi:"It is about 25 km from here to my grandparentsâ€™ house. (Khoáº£ng 25km tá»« Ä‘Ã¢y Ä‘áº¿n nhÃ  Ã´ng bÃ ).",
        data:{hintEN:"It is about ... km from here to ..."} },
      { id:"LB-3-3", type:"write", skill:"Grammar: It indicating distance (Write complete sentences).",
        prompt:"3) not very far / our school / the city museum",
        answer:"It is not very far from our school to the city museum.",
        explain:"Negative distance: not very far.",
        vi:"It is not very far from our school to the city museum. (KhÃ´ng xa tá»« trÆ°á»ng Ä‘áº¿n báº£o tÃ ng thÃ nh phá»‘).",
        data:{hintEN:"It is not very far from ... to ..."} },
      { id:"LB-3-4", type:"write", skill:"Grammar: It indicating distance (Write complete sentences).",
        prompt:"4) how far / your house / the gym?",
        answer:"How far is it from your house to the gym?",
        explain:"Question form: How far is it from A to B?",
        vi:"How far is it from your house to the gym? (Tá»« nhÃ  báº¡n Ä‘áº¿n phÃ²ng gym xa bao nhiÃªu?)",
        data:{hintEN:"How far is it from ... to ...?"} },
      { id:"LB-3-5", type:"write", skill:"Grammar: It indicating distance (Write complete sentences).",
        prompt:"5) it / a long distance / Ha Noi / Ban Gioc Waterfall!",
        answer:"It is a long distance from Ha Noi to Ban Gioc Waterfall!",
        explain:"It is + noun phrase (a long distance).",
        vi:"It is a long distance from Ha Noi to Ban Gioc Waterfall! (Tá»« HÃ  Ná»™i Ä‘áº¿n thÃ¡c Báº£n Giá»‘c ráº¥t xa!).",
        data:{hintEN:"It is a long distance from ... to ...!"} },

      { id:"LB-4-1", type:"mcq", skill:"Choose A, B, or C to complete the sentences.",
        prompt:"1) You ______ put the rubbish in the waste bins over there.",
        choices:["should","would","shouldnâ€™t"],
        answer:"should",
        explain:"Advice: you should put the rubbish in bins.",
        vi:"Báº¡n ______ bá» rÃ¡c vÃ o thÃ¹ng. â†’ should."},
      { id:"LB-4-2", type:"mcq", skill:"Choose A, B, or C to complete the sentences.",
        prompt:"2) You ______ be over eighteen to ride a motorbike.",
        choices:["would","must","could"],
        answer:"must",
        explain:"Rule/obligation: must.",
        vi:"Báº¡n ______ trÃªn 18 tuá»•i Ä‘á»ƒ lÃ¡i xe mÃ¡y. â†’ must."},
      { id:"LB-4-3", type:"mcq", skill:"Choose A, B, or C to complete the sentences.",
        prompt:"3) Children ______ ride their bikes too fast.",
        choices:["mightnâ€™t","wouldnâ€™t","shouldnâ€™t"],
        answer:"shouldnâ€™t",
        explain:"Advice: children shouldnâ€™t ride too fast.",
        vi:"Tráº» em ______ Ä‘áº¡p xe quÃ¡ nhanh. â†’ shouldnâ€™t."},
      { id:"LB-4-4", type:"mcq", skill:"Choose A, B, or C to complete the sentences.",
        prompt:"4) I am a bit lost. ______ you help me, please?",
        choices:["Could","Should","Might"],
        answer:"Could",
        explain:"Polite request: Could youâ€¦?",
        vi:"MÃ¬nh hÆ¡i láº¡c. ______ báº¡n giÃºp mÃ¬nh Ä‘Æ°á»£c khÃ´ng? â†’ Could."},
      { id:"LB-4-5", type:"mcq", skill:"Choose A, B, or C to complete the sentences.",
        prompt:"5) You ______ eat so many cookies. Too much sugar is bad for you.",
        choices:["couldnâ€™t","wouldnâ€™t","shouldnâ€™t"],
        answer:"shouldnâ€™t",
        explain:"Advice: shouldnâ€™t eat too many cookies.",
        vi:"Báº¡n ______ Äƒn nhiá»u bÃ¡nh quy nhÆ° váº­y. â†’ shouldnâ€™t."},
      { id:"LB-4-6", type:"mcq", skill:"Choose A, B, or C to complete the sentences.",
        prompt:"6) This is a big park. You ______ run or cycle here.",
        choices:["should","can","could"],
        answer:"can",
        explain:"Permission/ability: can.",
        vi:"ÄÃ¢y lÃ  cÃ´ng viÃªn lá»›n. Báº¡n ______ cháº¡y hoáº·c Ä‘áº¡p xe á»Ÿ Ä‘Ã¢y. â†’ can."}
    ]
  }
];

/* =========================
   2) STATE
========================= */
const state = {
  screenIndex: 0,
  startTs: null,
  elapsedSec: 0,
  answers: {},     // qid -> value or object
  submitted: {},   // key -> true
  showExplain: {}, // key -> bool
  showAnswers: {}, // key -> bool
  teacherMode: false
};

/* =========================
   3) UTIL
========================= */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.classList.remove("show"),2300);
}
function fmtTime(sec){
  sec=Math.max(0,Math.floor(sec));
  const m=String(Math.floor(sec/60)).padStart(2,"0");
  const s=String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function normText(s){ return String(s??"").trim().toLowerCase().replace(/\s+/g," "); }
function esc(s){ return String(s??"").replace(/[&<>"']/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[ch])); }
function escAttr(s){ return esc(s).replace(/"/g,"&quot;"); }

function loadJSON(key, fallback){
  try{ const raw=localStorage.getItem(key); return raw? JSON.parse(raw): fallback; }catch(e){ return fallback; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

function loadState(){
  const s=loadJSON(LS_STATE, null);
  if(!s) return;
  Object.assign(state, s);
}
function saveState(silent=true){
  saveJSON(LS_STATE, state);
  if(!silent) toast("ÄÃ£ lÆ°u tiáº¿n Ä‘á»™.");
}
function resetAll(){
  localStorage.removeItem(LS_STATE);
  localStorage.removeItem(LS_SHUF);
  // localStorage.removeItem(LS_AUDIO); // náº¿u muá»‘n xÃ³a audio Ä‘Ã£ náº¡p
  location.reload();
}

/* =========================
   4) SHUFFLE (khÃ´ng cá»‘ Ä‘á»‹nh vá»‹ trÃ­ Ä‘Ã¡p Ã¡n Ä‘Ãºng)
========================= */
function fyShuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function getShuffleMap(){ return loadJSON(LS_SHUF, {}); }
function setShuffleMap(m){ saveJSON(LS_SHUF, m||{}); }

function getShuffledChoices(q){
  const base = (q.choices||[]);
  const shuf=getShuffleMap();
  if(!shuf[q.id]){
    shuf[q.id]=fyShuffle(base);
    setShuffleMap(shuf);
  }
  const saved=shuf[q.id];
  const sameSet = saved.length===base.length && saved.every(x=>base.includes(x));
  if(!sameSet){
    shuf[q.id]=fyShuffle(base);
    setShuffleMap(shuf);
  }
  return shuf[q.id];
}
function resetShuffleForScreen(screen){
  const shuf=getShuffleMap();
  for(const q of (screen.items||[])){
    if(shuf[q.id]) delete shuf[q.id];
  }
  setShuffleMap(shuf);
}

/* =========================
   5) AUDIO PACK for Listening (offline)
========================= */
function getAudioPack(){ return loadJSON(LS_AUDIO, {}); }
function setAudioPack(p){ saveJSON(LS_AUDIO, p||{}); }

function base64ToBlob(base64, mime){
  const binStr = atob(base64);
  const len=binStr.length;
  const bytes=new Uint8Array(len);
  for(let i=0;i<len;i++) bytes[i]=binStr.charCodeAt(i);
  return new Blob([bytes], {type:mime||"audio/mpeg"});
}
function resolveAudioSrc(audioId){
  if(!audioId) return null;
  const pack=getAudioPack();
  if(pack[audioId]?.base64){
    const {mime, base64}=pack[audioId];
    return URL.createObjectURL(base64ToBlob(base64, mime));
  }
  return null;
}
async function loadAudioFromFile(audioId, file){
  const mime=file.type||"audio/mpeg";
  const buf=await file.arrayBuffer();
  const bytes=new Uint8Array(buf);
  let bin="";
  const chunk=0x8000;
  for(let i=0;i<bytes.length;i+=chunk){
    bin += String.fromCharCode(...bytes.subarray(i,i+chunk));
  }
  const base64=btoa(bin);
  const pack=getAudioPack();
  pack[audioId]={mime, base64};
  setAudioPack(pack);
}

/* =========================
   6) MUSIC (WebAudio) â€” OFFLINE
========================= */
let bg={ctx:null, master:null, isOn:true, vol:0.35, oscA:null, oscB:null, lfo:null, lfoGain:null};
function loadMusic(){
  const p=loadJSON(LS_MUSIC, {});
  if(typeof p.isOn==="boolean") bg.isOn=p.isOn;
  if(typeof p.vol==="number") bg.vol=Math.min(1,Math.max(0,p.vol));
}
function saveMusic(){ saveJSON(LS_MUSIC, {isOn:bg.isOn, vol:bg.vol}); }
function ensureMusic(){
  if(bg.ctx) return;
  const AC=window.AudioContext||window.webkitAudioContext;
  bg.ctx=new AC();
  bg.master=bg.ctx.createGain();
  bg.master.gain.value=bg.isOn?bg.vol:0;
  bg.master.connect(bg.ctx.destination);

  bg.oscA=bg.ctx.createOscillator(); bg.oscB=bg.ctx.createOscillator();
  bg.oscA.type="triangle"; bg.oscB.type="sine";
  bg.oscA.frequency.value=220; bg.oscB.frequency.value=330;
  const gA=bg.ctx.createGain(); gA.gain.value=0.08;
  const gB=bg.ctx.createGain(); gB.gain.value=0.06;

  bg.lfo=bg.ctx.createOscillator(); bg.lfo.type="sine"; bg.lfo.frequency.value=0.6;
  bg.lfoGain=bg.ctx.createGain(); bg.lfoGain.gain.value=15;
  bg.lfo.connect(bg.lfoGain); bg.lfoGain.connect(bg.oscA.frequency);

  const filter=bg.ctx.createBiquadFilter(); filter.type="lowpass"; filter.frequency.value=900;

  bg.oscA.connect(gA); gA.connect(filter);
  bg.oscB.connect(gB); gB.connect(filter);
  filter.connect(bg.master);

  bg.oscA.start(); bg.oscB.start(); bg.lfo.start();

  let step=0;
  setInterval(()=>{
    if(!bg.ctx) return;
    const seq=[[220,330],[246.94,370],[196,293.66],[220,329.63]];
    const [f1,f2]=seq[step%seq.length]; step++;
    try{
      bg.oscA.frequency.setTargetAtTime(f1, bg.ctx.currentTime, 0.08);
      bg.oscB.frequency.setTargetAtTime(f2, bg.ctx.currentTime, 0.08);
    }catch(e){}
  },1800);
}
function updateMusicUI(){
  document.getElementById("btnMusic").textContent=`Nháº¡c: ${bg.isOn?"ON":"OFF"}`;
  document.getElementById("vol").value=Math.round(bg.vol*100);
}
function setMusic(on){
  bg.isOn=on; ensureMusic();
  bg.master.gain.value = bg.isOn?bg.vol:0;
  saveMusic(); updateMusicUI();
}
function setVol(v01){
  bg.vol=Math.min(1,Math.max(0,v01)); ensureMusic();
  bg.master.gain.value = bg.isOn?bg.vol:0;
  saveMusic(); updateMusicUI();
}

/* =========================
   7) SCORING
========================= */
function allQuestions(){
  const out=[];
  CONTENT.forEach(screen => (screen.items||[]).forEach(q => {
    if(q.type!=="info" && q.type!=="listening") out.push({screenKey:screen.key, ...q});
  }));
  return out;
}
function scoreOne(q, ua){
  if(ua==null || String(ua).trim()==="") return {answered:false, correct:false, point:0};
  if(q.type==="mcq"){
    const ok = normText(ua)===normText(q.answer);
    return {answered:true, correct:ok, point: ok?1:0};
  }
  if(q.type==="fill"){
    // náº¿u Ä‘Ã¡p Ã¡n placeholder thÃ¬ khÃ´ng cháº¥m
    if(String(q.answer).includes("[Cáº¦N")) return {answered:true, correct:true, point:0};
    const ok = normText(ua)===normText(q.answer);
    return {answered:true, correct:ok, point: ok?1:0};
  }
  if(q.type==="write"){
    const list = Array.isArray(q.answer)? q.answer : [q.answer];
    const u=normText(ua);
    const ok = list.filter(Boolean).some(s=>u===normText(s));
    return {answered:true, correct:ok, point: ok?1:0};
  }
  if(q.type==="match"){
    const ans=q.answer||{};
    const u=(typeof ua==="object" && ua)?ua:{};
    const keys=Object.keys(ans);
    if(!keys.length) return {answered:false, correct:false, point:0};
    const ok=keys.every(k=>String(u[k]||"").trim()===String(ans[k]).trim());
    return {answered:true, correct:ok, point: ok?1:0};
  }
  return {answered:false, correct:false, point:0};
}
function totals(){
  const qs=allQuestions();
  let correct=0, wrong=0, points=0, answered=0;
  qs.forEach(q=>{
    const ua=state.answers[q.id];
    const s=scoreOne(q, ua);
    if(s.answered) answered++;
    if(s.correct) correct++; else if(s.answered) wrong++;
    points += s.point;
  });
  const totalQ = qs.length;
  const pct = totalQ? Math.round(correct/totalQ*100):0;
  const done = totalQ? Math.round(answered/totalQ*100):0;
  return {correct, wrong, points, totalQ, pct, done};
}

/* =========================
   8) RENDER
========================= */
function renderNav(){
  const nav=document.getElementById("nav");
  nav.innerHTML="";
  CONTENT.forEach((sec,i)=>{
    const done = !!state.submitted[sec.key];
    explaining = !!state.showExplain[sec.key];
    const div=document.createElement("div");
    div.className="navItem"+(i===state.screenIndex?" active":"");
    div.innerHTML=`
      <div>
        <div style="font-weight:900">${esc(sec.title)}</div>
        <div class="small">${esc(sec.key)} â€¢ ${done?"ÄÃ£ ná»™p":"ChÆ°a ná»™p"}</div>
      </div>
      <div class="badge">${i+1}/${CONTENT.length}</div>
    `;
    div.onclick=()=>{ state.screenIndex=i; saveState(true); render(); window.scrollTo({top:0,behavior:"smooth"}); };
    nav.appendChild(div);
  });
}
function renderKPI(){
  const t=totals();
  document.getElementById("kCorrect").textContent=t.correct;
  document.getElementById("kWrong").textContent=t.wrong;
  document.getElementById("kPercent").textContent=`${t.pct}%`;
  document.getElementById("kDone").textContent=`${t.done}%`;
  document.getElementById("scoreBadge").textContent=`${t.points} Ä‘iá»ƒm`;

  const submittedCount = CONTENT.filter(s=>state.submitted[s.key]).length;
  const pct = Math.round(submittedCount/CONTENT.length*100);
  document.getElementById("progressText").textContent=`${submittedCount}/${CONTENT.length} pháº§n â€¢ ${pct}%`;
  document.getElementById("progressBar").style.width=`${pct}%`;
}
function render(){
  renderNav(); renderKPI();
  const sec=CONTENT[state.screenIndex];

  document.getElementById("sectionTitle").textContent=sec.title;
  document.getElementById("sectionSub").textContent=sec.sub;

  const submitted=!!state.submitted[sec.key];
  document.getElementById("btnSubmit").disabled=submitted;
  document.getElementById("btnSubmit").textContent=submitted?"ÄÃ£ ná»™p":"Ná»™p bÃ i";
  document.getElementById("btnExplain").textContent=state.showExplain[sec.key]?"áº¨n giáº£i thÃ­ch":"Giáº£i thÃ­ch";
  document.getElementById("btnAnswers").textContent=(state.showAnswers[sec.key]||state.teacherMode)?"áº¨n Ä‘Ã¡p Ã¡n":"Xem Ä‘Ã¡p Ã¡n";

  const stage=document.getElementById("stage");
  stage.innerHTML="";

  if(sec.passage){
    const p=document.createElement("div");
    p.className="card";
    p.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div style="min-width:280px;flex:1">
          <div style="font-weight:900">${esc(sec.passage.title||"Passage")}</div>
          <div class="small" style="margin-top:10px"><b>EN</b></div>
          <pre>${esc(sec.passage.textEN||"")}</pre>
          <div class="small" style="margin-top:10px"><b>VI</b></div>
          <pre>${esc(sec.passage.textVI||"")}</pre>
        </div>
        <div class="badge">${esc(sec.key)}</div>
      </div>
    `;
    stage.appendChild(p);
    stage.appendChild(document.createElement("div")).style.height="10px";
  }

  (sec.items||[]).forEach(q=>stage.appendChild(renderQuestion(sec, q)));
}

function renderQuestion(sec, q){
  const div=document.createElement("div");
  div.className="q";

  const submitted=!!state.submitted[sec.key];
  const showExplain=!!state.showExplain[sec.key];
  const showAnswers=!!state.showAnswers[sec.key] || state.teacherMode;

  const ua=state.answers[q.id];
  const sc = (submitted && q.type!=="info" && q.type!=="listening") ? scoreOne(q, ua) : null;

  let badge = (submitted && sc)
    ? (sc.correct ? `<span class="tag good">ÄÃšNG +${sc.point}</span>` : (sc.answered ? `<span class="tag bad">SAI +0</span>` : `<span class="tag">CHÆ¯A TRáº¢ Lá»œI</span>`))
    : `<span class="tag">${esc(q.type.toUpperCase())}</span>`;

  let body="";

  if(q.type==="info"){
    // custom displays: icons lists
    if(q.id==="GS-4"){
      const icons = CONTENT[0].items.find(x=>x.id==="GS-4").data.icons;
      body += `<div class="gridIcons">` + icons.map(it=>`
        <div class="iconCard">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
            <div><div class="iconBig">${it.icon}</div><div class="small">${it.labelEN} â€¢ ${it.labelVI}</div></div>
            <div class="badge">#${it.n}</div>
          </div>
        </div>
      `).join("") + `</div>`;
    }
    if(q.id==="CL1-2"){
      const phrases=q.data.phrases||[];
      const signs=q.data.signs||[];
      body += `<div class="card" style="margin-top:10px">
        <div style="font-weight:900">Phrases:</div>
        <div class="small" style="margin-top:6px">${phrases.map(p=>`<span class="badge" style="margin:2px 6px 0 0;display:inline-block">${esc(p)}</span>`).join("")}</div>
      </div>`;
      body += `<div class="gridIcons">` + signs.map(s=>`
        <div class="iconCard">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px">
            <div>
              <div class="iconBig">${s.icon}</div>
              <div class="small">Hint: ${esc(s.hint)}</div>
            </div>
            <div class="badge">${s.n}</div>
          </div>
        </div>
      `).join("") + `</div>`;
    }
    if(q.id==="SK1-TEXT"){
      body += `<div class="card" style="margin-top:10px">
        <div class="small"><b>EN</b></div>
        <pre>${esc(q.data.textEN||"")}</pre>
        <div class="small" style="margin-top:10px"><b>VI</b></div>
        <pre>${esc(q.data.textVI||"")}</pre>
      </div>`;
    }
    body += `<div class="small" style="margin-top:10px">${esc(q.vi||"")}</div>`;
  }

  if(q.type==="listening"){
    const audioId=q.data.audioId;
    const src=resolveAudioSrc(audioId);
    body += `
      <div class="card" style="margin-top:10px">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900">Listening Audio</div>
            <div class="small">Audio ID: <span class="mono">${esc(audioId)}</span></div>
          </div>
          <label class="btn primary" style="display:inline-flex;align-items:center;gap:8px">
            Náº¡p audio
            <input id="file-${escAttr(audioId)}" type="file" accept="audio/*" style="display:none"/>
          </label>
        </div>
        <div id="audioArea-${escAttr(audioId)}" style="margin-top:10px"></div>
        <details style="margin-top:10px">
          <summary class="small">Gá»£i Ã½ transcript</summary>
          <div class="hr"></div>
          <div class="note small">Náº¿u báº¡n gá»­i thÃªm trang Listening (Activity 3) vÃ  file audio chuáº©n cá»§a Unit 7, tÃ´i sáº½ Ä‘iá»n transcript + cÃ¢u há»i nghe Ä‘áº§y Ä‘á»§.</div>
        </details>
      </div>
    `;
    // bind after insert
    setTimeout(()=>{
      const area=document.getElementById(`audioArea-${audioId}`);
      if(area){
        area.innerHTML = src ? `<audio controls preload="metadata" src="${escAttr(src)}"></audio>`
                             : `<div class="note small">ChÆ°a cÃ³ audio. Báº¥m â€œNáº¡p audioâ€ Ä‘á»ƒ chá»n mp3/m4a; há»‡ thá»‘ng sáº½ lÆ°u offline.</div>`;
      }
      const input=document.getElementById(`file-${audioId}`);
      if(input){
        const lbl=input.closest("label");
        if(lbl){
          lbl.onclick=()=>input.click();
        }
        input.onchange=async ()=>{
          const f=input.files && input.files[0];
          if(!f) return;
          await loadAudioFromFile(audioId, f);
          toast("ÄÃ£ náº¡p audio vÃ  lÆ°u offline.");
          render();
        };
      }
    },0);
  }

  if(q.type==="mcq"){
    const choices = getShuffledChoices(q);
    body += `<div class="opts">` + choices.map(c=>{
      const checked = (ua===c);
      let cls="opt";
      if(submitted && showAnswers){
        if(normText(c)===normText(q.answer)) cls+=" correct";
        else if(checked && normText(c)!==normText(q.answer)) cls+=" wrong";
      }
      return `
        <label class="${cls}">
          <input type="radio" name="${q.id}" ${checked?"checked":""} ${submitted?"disabled":""}
            onchange="setAns('${q.id}', ${JSON.stringify(c)})">
          <div>${esc(c)}</div>
        </label>
      `;
    }).join("") + `</div>`;
  }

  if(q.type==="fill"){
    body += `
      <div style="margin-top:10px">
        <input class="inp" value="${escAttr(ua||"")}" ${submitted?"disabled":""}
          placeholder="Type ONE word / phrase..."
          oninput="setAns('${q.id}', this.value)">
      </div>
    `;
  }

  if(q.type==="write"){
    body += `
      <div class="small" style="margin-top:8px"><b>Gá»£i Ã½:</b> ${esc(q.data?.hintEN||"Write a complete sentence.")}</div>
      <div style="margin-top:10px">
        <textarea class="inp" style="width:100%;min-height:90px" ${submitted?"disabled":""}
          placeholder="Write your sentence..."
          oninput="setAns('${q.id}', this.value)">${esc(ua||"")}</textarea>
      </div>
      ${q.data?.sampleEN ? `
        <details style="margin-top:8px">
          <summary class="small">ÄÃ¡p Ã¡n máº«u (tham kháº£o)</summary>
          <div class="small" style="margin-top:8px"><b>EN:</b> ${esc(q.data.sampleEN||"")}</div>
          <div class="small" style="margin-top:6px"><b>VI:</b> ${esc(q.data.sampleVI||"")}</div>
        </details>` : "" }
    `;
  }

  if(q.type==="match"){
    const left=q.data.left||[], right=q.data.right||[];
    const u=(typeof ua==="object" && ua)?ua:{};
    body += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
      <div class="card"><div style="font-weight:900;margin-bottom:8px">A</div>
        ${left.map(it=>{
          const sel=u[it.k]||"";
          const opts=right.map(r=>`<option value="${escAttr(r.k)}" ${sel===r.k?"selected":""}>${esc(r.k)}. ${esc(r.text)}</option>`).join("");
          return `
            <div class="q" style="margin:0 0 8px 0">
              <div style="font-weight:900">${esc(it.k)}. ${esc(it.text)}</div>
              <div style="margin-top:8px">
                <select class="inp" ${submitted?"disabled":""} onchange="setMatch('${q.id}','${it.k}',this.value)">
                  <option value="">-- chá»n --</option>
                  ${opts}
                </select>
              </div>
            </div>
          `;
        }).join("")}
      </div>
      <div class="card"><div style="font-weight:900;margin-bottom:8px">B</div>
        ${right.map(r=>`<div class="q" style="margin:0 0 8px 0"><b>${esc(r.k)}.</b> ${esc(r.text)}</div>`).join("")}
      </div>
    </div>`;
  }

  const explainBlock = (q.type==="info" || q.type==="listening") ? "" : `
    <div class="explain ${(submitted && (showExplain || showAnswers)) ? "show":""}">
      <div class="row"><b>ÄÃ¡p Ã¡n:</b> <span class="mono">${esc(formatAnswer(q))}</span></div>
      <div class="row"><b>Giáº£i thÃ­ch:</b> ${esc(q.explain || q.vi_explain || "")}</div>
      <div class="row"><b>Dá»‹ch Viá»‡t:</b> ${esc(q.vi || "")}</div>
    </div>
  `;

  div.innerHTML=`
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div class="qTitle">${esc(q.id)} â€” ${esc(q.prompt)}</div>
        <div class="small">${esc(q.skill||"")}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">${badge}</div>
    </div>
    ${body}
    ${explainBlock}
  `;
  return div;
}

function formatAnswer(q){
  if(q.type==="match"){
    return Object.entries(q.answer||{}).map(([k,v])=>`${k}â†’${v}`).join(", ");
  }
  if(q.type==="write"){
    const list=Array.isArray(q.answer)?q.answer:[q.answer];
    return list.filter(Boolean).join(" | ");
  }
  return String(q.answer??"");
}

/* =========================
   9) ACTIONS
========================= */
function setAns(qid, val){
  state.answers[qid]=val;
  saveState(true);
  renderKPI();
}
function setMatch(qid, k, v){
  const cur=(typeof state.answers[qid]==="object" && state.answers[qid])?state.answers[qid]:{};
  cur[k]=v;
  state.answers[qid]=cur;
  saveState(true);
  renderKPI();
}

function submitSection(){
  const sec=CONTENT[state.screenIndex];
  if(state.submitted[sec.key]) return;
  state.submitted[sec.key]=true;
  saveState(true);
  render();
  toast("ÄÃ£ ná»™p pháº§n nÃ y.");
}
function retrySection(){
  const sec=CONTENT[state.screenIndex];
  (sec.items||[]).forEach(q=>{ delete state.answers[q.id]; });
  state.submitted[sec.key]=false;
  state.showExplain[sec.key]=false;
  state.showAnswers[sec.key]=false;
  resetShuffleForScreen(sec);
  saveState(true);
  render();
  toast("ÄÃ£ lÃ m láº¡i pháº§n nÃ y (Ä‘Ã¡p Ã¡n sáº½ xÃ¡o trá»™n láº¡i).");
}
function toggleExplain(){
  const sec=CONTENT[state.screenIndex];
  state.showExplain[sec.key]=!state.showExplain[sec.key];
  saveState(true); render();
}
function toggleAnswers(){
  const sec=CONTENT[state.screenIndex];
  state.showAnswers[sec.key]=!state.showAnswers[sec.key];
  saveState(true); render();
}
function nextSection(){
  if(state.screenIndex < CONTENT.length-1){
    state.screenIndex++;
    saveState(true);
    render();
    window.scrollTo({top:0,behavior:"smooth"});
  }else{
    exportReport();
  }
}
async function exportReport(){
  const rep=buildReport();
  try{
    await navigator.clipboard.writeText(rep);
    toast("ÄÃ£ sao chÃ©p bÃ¡o cÃ¡o (Ctrl+V Ä‘á»ƒ dÃ¡n).");
  }catch(e){
    const ta=document.createElement("textarea");
    ta.value=rep; ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta); ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
    toast("ÄÃ£ sao chÃ©p bÃ¡o cÃ¡o.");
  }
}
function buildReport(){
  const t=totals();
  const submittedCount = CONTENT.filter(s=>state.submitted[s.key]).length;
  const lines=[];
  lines.push("BÃO CÃO Káº¾T QUáº¢ â€” GS7 UNIT 7 TRAFFIC");
  lines.push("-----------------------------------");
  lines.push(`Thá»i gian: ${fmtTime(state.elapsedSec)}`);
  lines.push(`ÄÃ£ ná»™p: ${submittedCount}/${CONTENT.length}`);
  lines.push(`Tá»•ng Ä‘iá»ƒm: ${t.points}/${t.totalQ}`);
  lines.push(`ÄÃºng: ${t.correct} | Sai: ${t.wrong} | % Ä‘Ãºng: ${t.pct}%`);
  lines.push("");
  lines.push("Chi tiáº¿t:");
  allQuestions().forEach(q=>{
    const ua=state.answers[q.id];
    const s=scoreOne(q, ua);
    lines.push(`- ${q.id} (${q.type}) ${s.answered?(s.correct?"ÄÃšNG":"SAI"):"CHÆ¯A"} | TL: ${String(ua??"")} | ÄA: ${formatAnswer(q)}`);
  });
  return lines.join("\n");
}

/* =========================
   10) TIMER
========================= */
function startTimer(){
  if(state.startTs==null) state.startTs=Date.now();
  setInterval(()=>{
    if(state.startTs!=null){
      state.elapsedSec=Math.floor((Date.now()-state.startTs)/1000);
      document.getElementById("timer").textContent=fmtTime(state.elapsedSec);
      if(state.elapsedSec%10===0) saveState(true);
    }
  },1000);
}

/* =========================
   11) TEACHER MODE
========================= */
function teacherMode(){
  const code=prompt("Nháº­p mÃ£ giÃ¡o viÃªn Ä‘á»ƒ xem Ä‘Ã¡p Ã¡n:");
  if(code==null) return;
  if(code.trim()===TEACHER_CODE){
    state.teacherMode=true; saveState(true); render(); toast("ÄÃ£ báº­t cháº¿ Ä‘á»™ giÃ¡o viÃªn.");
  }else toast("MÃ£ khÃ´ng Ä‘Ãºng.");
}

/* =========================
   12) WIRE UI + INIT
========================= */
function wire(){
  document.getElementById("btnSubmit").onclick=submitSection;
  document.getElementById("btnRetry").onclick=retrySection;
  document.getElementById("btnExplain").onclick=toggleExplain;
  document.getElementById("btnAnswers").onclick=toggleAnswers;
  document.getElementById("btnNext").onclick=nextSection;
  document.getElementById("btnExport").onclick=exportReport;
  document.getElementById("btnSave").onclick=()=>{ saveState(false); };
  document.getElementById("btnReset").onclick=resetAll;
  document.getElementById("btnTeacher").onclick=teacherMode;

  document.getElementById("btnMusic").onclick=async ()=>{
    ensureMusic();
    if(bg.ctx && bg.ctx.state==="suspended"){ try{ await bg.ctx.resume(); }catch(e){} }
    setMusic(!bg.isOn);
  };
  document.getElementById("vol").oninput=async (e)=>{
    ensureMusic();
    if(bg.ctx && bg.ctx.state==="suspended"){ try{ await bg.ctx.resume(); }catch(e){} }
    setVol(Number(e.target.value)/100);
  };

  window.addEventListener("pointerdown", async ()=>{
    if(bg.ctx && bg.ctx.state==="suspended"){ try{ await bg.ctx.resume(); }catch(e){} }
  }, {once:true});
}

(function init(){
  loadState();
  loadMusic();
  updateMusicUI();
  wire();
  startTimer();
  render();
})();
</script>
</body>
</html>
